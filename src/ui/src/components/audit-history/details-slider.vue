<template>
  <bk-sideslider
    :width="760"
    :title="$t('操作详情')"
    :is-show.sync="isShow"
    @hidden="handleHidden">
    <div class="details-content" slot="content"
      v-bkloading="{ isLoading: pending }">
      <component
        v-if="details"
        :is="detailsType"
        :details="details">
      </component>
    </div>
  </bk-sideslider>
</template>

<script>
  import DetailsJson from './details-json'
  import DetailsTable from './details-table'
  import {
    BUILTIN_MODELS,
    BUILTIN_MODEL_RESOURCE_TYPES
  } from '@/dictionary/model-constants.js'

  export default {
    components: {
      [DetailsJson.name]: DetailsJson,
      [DetailsTable.name]: DetailsTable
    },
    props: {
      id: Number,
      bizId: {
        type: Number
      },
      objId: {
        type: String,
      },
      resourceType: {
        type: String,
        default: ''
      },
      /**
       * 审计目标，不同类型的对象的权限可能不一样，所以需要区分审计目标，可选值 instance（资源实例）、common（通用），如果不需要特殊鉴权，默认为 common
       */
      aduitTarget: {
        type: String,
        default: 'common',
        validator: val => ['instance', 'common'].includes(val)
      }
    },
    data() {
      return {
        details: null,
        isShow: false,
        pending: true
      }
    },
    computed: {
      detailsType() {
        if (!this.details) {
          return null
        }
        const withCompare = [
          BUILTIN_MODEL_RESOURCE_TYPES[BUILTIN_MODELS.HOST],
          BUILTIN_MODEL_RESOURCE_TYPES[BUILTIN_MODELS.BUSINESS],
          BUILTIN_MODEL_RESOURCE_TYPES[BUILTIN_MODELS.BUSINESS_SET],
          'module',
          'set',
          'mainline_instance',
          'model_instance',
          'cloud_area'
        ]
        return withCompare.includes(this.details.resource_type) ? DetailsTable.name : DetailsJson.name
      }
    },
    async created() {
      this.getDetails()
    },
    methods: {
      show() {
        this.isShow = true
      },
      handleHidden() {
        this.$emit('close')
      },
      async getDetails() {
        try {
          this.pending = true

          if (this.aduitTarget === 'instance') {
            this.details = await this.$store.dispatch('audit/getInstDetails', {
              params: {
                condition: {
                  bk_biz_id: this.bizId,
                  bk_obj_id: this.objId,
                  resource_type: this.resourceType,
                  id: [this.id]
                },
                with_detail: true
              }
            })
          }

          if (this.aduitTarget === 'common') {
            this.details = await this.$store.dispatch('audit/getDetails', {
              id: this.id
            })
          }
        } catch (error) {
          console.error(error)
          this.details = null
        } finally {
          this.pending = false
        }
      }
    }
  }
</script>

<style lang="scss" scoped>
    .details-content {
        height: calc(100vh - 60px);
        padding: 20px;
    }
</style>
